# このリポジトリは？
このリポジトリでは、IoTデバイスのデータ保存先にGoogle Sheetsを使う例を示しています。

- データを送信するIoTデバイスをArduino環境で作成します。
- Google SheetsとGASを組み合わせてIoTデバイスからのデータを記録します。
- Arduinoによる簡易的なデータビュワを作成し、小型のガジェットで最新のデータを確認できるようにします。

# 解決したい問題点
一般的なIoTデータ収録では特定のサービスプロバイダと契約して、データストレージやグラフ化などのサービスを組み合わせてデータ収録系を構築します。<br>
しかし、IoTのフィジビリティ確認やテストの段階では機能がオーバースペックなところも多々あることや、サービス独自のデータ構造や取り扱い手法などを習得しつつコードを書く必要があり、学習コストも高くなりがちです。<br>
そこでGoogle Sheets と Google Apps Script（GAS）を組み合わせてデータ収集のwebアプリ的なものを作り、簡易的なIoTデータ収録ができないだろうかと考えました。<br>
Google SheetsのwebアプリとGASについてはインターネット上に資料や参考となる実装例が豊富にあるため、学習コストが低く抑えられると考えられます。同時に情報が多いということは生成AIによる手助けを期待することができます。<br>
構成の自由度の高さという点では、インターネットにアクセスできるデバイスであれば比較的簡単にGoogle Sheetsに向けてデータを送信することがでるため、必要に応じ多様なデバイスをシステムに利用することができます。また、柔軟性の高いGASを用いるのでデータのグラフ化やアラーム発呼などの処理をスクリプトとして記述して十分に実用的なシステムを構成できる可能性があると考えます。

# なにが書かれているか
このリポジトリでは、以下のことをまとめています。
- 基本的なデータ保存のためのGoogle Sheets用GASコード
- データを送るエッジデバイス（Arduinoを利用）のコード
- 最新のデータを参照するエッジデバイス（ガジェット）のコード


# システムの全体像
<br>
<img src="https://github.com/user-attachments/assets/61072de2-511e-486b-8f23-e3b3107718ad" width="500">
<br><br>

この図に示したように、データ収集のIoTデバイスはGoogle Sheetsに向けてGASを通じてHTTPプロトコル(POSTメソッド)でデータを送ります。<br>
送られたデータはスプレッドシート上に受信時間のタイムスタンプと共に記録され、シートを開くことで人間が直接確認することができます。<br>
送られるデータはJSONフォーマットで、データのキーごとにGoogle Sheets上の１列を使います。JSONのキー名とシート上の列の対応はGASスクリプトで決めています。

__例：エッジデバイスからのデータが保存されたスプレッドシート__
<br>
<img src="https://github.com/user-attachments/assets/75e31621-432e-40fd-957b-bf36b398cefd" width="500">
<br>（グラフは手作業で追加しています）<br>

HTTPでの読み出しリクエスト（GETメソッド）に応答して、表内（保存データ）の一部のデータを参照し、その内容をデバイス上で表示する「Viewer」をArduinoで作成ました。

# 使い方
## Google Sheets:
- Google Sheets で新しいファイルを作成し、ツール - AppScript を選択。<br>
- エディタ画面になるので、このリポジトリの.gs拡張子のファイルの内容をコピーする。<br>
- 画面右上の「デプロイ」を押して「新しいデプロイ」を選択。<br>
- ポップアップウインドが出てくるので、左側のベイン「種類の選択」の歯車マークを押して、「ウエブアプリ」を選択<BR>
- 左側の「設定」に必要な事項を記入して、「アクセスできるユーザ」を全員に設定。「デプロイ」を押す<br>
- ここで表示されるURLがエッジデバイスの設定で必要となるのでコピーなどしておく。

## エッジデバイス(Arduino):
- リポジトリのArduinoディレクトリの下に2つのスケッチのフォルダがある。
- ArduinoIDEを起動して、必要なスケッチのフォルダからスケッチ本体を開く。
- `SAMPLE_config.h` のファイル名を `config.h` に変更し、内容を自分の環境に合うように設定。このとき、API_URLに先ほどデプロイしたGASのURLを記載する。
- このファイルで設定したSENSOR_IDがシートの名前になる。（一つのSheetに複数のエッジデバイスのデータを保管可能なので、Sheetでセンサのグルーピングが可能）
- デバイスを用意してArduinoIDEでコンパイル。その後デバイスへダウンロードし、実行する。
- シリアルポートで動作の様子がわかるのでデバグ時にはシリアルターミナルを開いておくといい。

### スケッチの簡単な説明
詳しくはソースコードをご覧ください。
#### AtomS3Lite_EnvIoT_withGAS
- 10分ごとに環境センサから気温などのデータを取得し、そのデータをGoogle Sheetsに送信する。
- センサが別途必要
  
#### AtomS3LCD_IoT_viewer
- Google Sheetsの中の一番新しいデータを受け取り、LCDに表示する。



## 注意
- 複数のデバイスで同じSENSOR_IDを使うことも可能だが、デバイス間の送信タイミングが同期できないのでシート上のタイムスタンプは別々になってしまう。
- タイムスタンプは受信時に押される。
- デバイスからのデータ送信周期はかなりばらつきがあり、正確ではない。
- デバイスでは、API側でデータ受信がされたかどうかの確認をしていないので、シート上にあるデータの完全性は保証されない。欠落したデータがある可能性がある。
- Google Sheetsのデータ数上限はひとつのファイルで1000万セルのようなので、それを超えるとデータ追加ができなくなる。制限を超えないように古いデータはCVSで保存した後シート上から削除するようなスクリプトの定期実行が必要かもしれない。（とはいえ、1000万セルで10分ごとのデータだと数十年は使える計算）
- このGASコードはGoogleの運用方針転換で突然動かなくなる可能性もありますのでご留意ください。
  
